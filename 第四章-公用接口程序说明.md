# 第四章. 公用接口程序说明

## 1.1 全局变量

### 表4-1 全局变量定义表

| 名称 | 说明 | 数据类型 | 长度 | 取值范围 |
|------|------|---------|------|---------|
| errlogpath | 错误日志路径 | 字符串 | 260 Byte | 应用程序目录\log\errlog.log |
| mainlogpath | 运行日志路径 | 字符串 | 260 Byte | 应用程序目录\log\mainlog.log |
| tmplogpath | 本次运行日志路径 | 字符串 | 260 Byte | 应用程序目录\log\tmplog.log |
| helpdocument | 帮助文档路径 | 字符串 | 260 Byte | 应用程序目录\data\用户手册.pdf |
| dbpath | 软件数据库路径 | 字符串 | 260 Byte | 应用程序目录\data\config\zjzx_zjrj.db |
| savemxdpath | MXD工程文件保存路径 | 字符串 | 260 Byte | 应用程序目录\data\config\project.mxd |
| taskcachepath | 任务列表缓存路径 | 字符串 | 260 Byte | 应用程序目录\data\config\task.csv |
| toolconfigpath | 工具配置文件路径 | 字符串 | 260 Byte | 应用程序目录\data\tool\config.csv |
| tooldescpath | 工具描述文件路径 | 字符串 | 260 Byte | 应用程序目录\data\tool\工具描述.xlsx |
| updatedespath | 版本更新描述文件路径 | 字符串 | 260 Byte | 应用程序目录\data\updateInfo.txt |
| mu_rulepath | 规则模板文件夹路径 | 字符串 | 260 Byte | 应用程序目录\data\mu_src\rule |
| mu_markpath | 评分模板文件夹路径 | 字符串 | 260 Byte | 应用程序目录\data\mu_src\mark |
| mu_standard | 标准查阅文件夹路径 | 字符串 | 260 Byte | 应用程序目录\data\mu_src\standard |
| mu_task | 预设任务文件夹路径 | 字符串 | 260 Byte | 应用程序目录\data\mu_src\task |
| inipath | INI配置文件路径 | 字符串 | 260 Byte | 应用程序目录\data\config.ini |
| svgpath | SVG图标资源路径 | 字符串 | 260 Byte | 应用程序目录\data\svg |
| homepagepicpath | 主页图片文件夹路径 | 字符串 | 260 Byte | 应用程序目录\data\svg\homepage |
| sidetoolbox | 其他工具箱路径 | 字符串 | 260 Byte | 应用程序目录\data\sidetool\sidetool.tbx |
| translate_xml | 元数据转换模板路径 | 字符串 | 260 Byte | 应用程序目录\data\config\Translator\ARCGIS2ISO19139.xml |
| coordinate_txt_path | 坐标文件夹路径 | 字符串 | 260 Byte | 应用程序目录\data\coordinate |
| controlcsvpath | Control.csv文件路径 | 字符串 | 260 Byte | 应用程序目录\data\plug\数据统计\Control.csv |
| mappingcsvpath | mapping.csv文件路径 | 字符串 | 260 Byte | 应用程序目录\data\plug\数据统计\mapping.csv |
| gptasklist | GP任务列表字典 | Dictionary<string, string> | 不定 | 键值对集合 |
| mainlog | 日志内容缓存 | 字符串 | 不定 | 无限制 |
| GpBeanList | GP任务对象列表 | List<GpBean> | 不定 | GpBean对象集合 |
| defaultGdbPath | 默认工作空间路径 | 字符串 | 260 Byte | 用户设置的GDB路径 |
| isArcGisInitialized | GIS控件初始化标志 | 布尔型 | 1 Byte | true/false |

---

## 1.2 公用界面或接口

### 公共界面：软件主界面

#### 输入数据要求：

| 操作 | 要求 | 详细处理说明 |
|------|------|-------------|
| 工具选择 | 需从左侧菜单选择工具 | 通过一级菜单切换工具分类，在树形菜单中点击具体工具，系统自动打开对应工具窗体，加载工具参数配置界面 |
| 整体检查 | 需加载汇交成果数据 | 通过既定模式按质检规范中的文件组织规范要求，指定本地汇交数据目录，不存在或未按规范命名的文件进行标红提示，对其他数据进行完整性、规范性、一致性单项检查或全部检查 |
| 单类检查 | 需选择待检查数据项 | 支持对矢量数据、栅格数据、图件数据、文档数据、属性数据、元数据、MXD文档进行单类检查。选择文件路径，加载单项数据，软件自动匹配对应文件名，进行完整性、规范性、一致性检查，若未成功匹配则手动指定所属文件 |
| 参数设置 | 需设置默认参数 | 设置成果数据库路径、模板文件夹路径、输出位置（GDB）、输出位置（文件夹）等默认参数，供工具调用 |
| 地图操作 | 可选，支持地图可视化 | 支持加载要素类、图层管理、地图保存等操作，通过ArcGIS控件实现地图交互功能 |
| 任务管理 | 可选，查看历史任务 | 打开任务管理窗口，查看历史执行记录、任务状态、运行时间等信息，支持任务重新执行 |
| 日志查看 | 可选，查看运行日志 | 打开日志窗口，实时查看软件运行日志、错误信息、操作记录等 |
| 模板下载 | 可选，下载配置模板 | 打开模板下载窗口，选择并下载规则模板、评分模板等配置文件 |
| 帮助文档 | 无 | 打开PDF格式的用户手册，查看软件使用说明 |

---

## 1.3 公用方法和过程

### 表4-2 公用方法说明表

#### 1. 日志处理类 (LogHelper)

| 方法名称 | add2mainlog |
|---------|------------|
| 功能描述 | 添加日志到主日志窗体并写入日志文件 |
| 输入参数 | string input：日志文本内容<br>Color color：日志文本颜色（可选，默认黑色） |
| 输出参数 | void |
| 处理逻辑 | 1. 检查输入是否为空<br>2. 将日志内容追加到全局日志变量<br>3. 如果主日志窗体已打开，则在窗体中显示日志并设置颜色<br>4. 调用writeMainLog方法将日志写入本地文件 |
| 适用范围 | 日志记录，软件执行记录，操作追踪 |

| 方法名称 | ErrorLog |
|---------|----------|
| 功能描述 | 记录错误日志并弹出错误通知 |
| 输入参数 | string text：错误标题<br>Exception ex：异常对象 或 string errmsg：错误消息 |
| 输出参数 | void |
| 处理逻辑 | 1. 提取错误消息<br>2. 获取当前时间戳<br>3. 显示错误通知弹窗<br>4. 添加红色日志到主日志<br>5. 写入错误日志文件 |
| 适用范围 | 异常处理，错误记录 |

| 方法名称 | Successnotice |
|---------|--------------|
| 功能描述 | 显示成功通知并记录日志 |
| 输入参数 | string msg：成功消息内容<br>int closecount：通知自动关闭时间（可选，默认6秒） |
| 输出参数 | void |
| 处理逻辑 | 1. 获取主窗体实例<br>2. 在主线程中显示成功通知<br>3. 添加时间戳<br>4. 记录日志到主日志 |
| 适用范围 | 操作成功提示，任务完成通知 |

| 方法名称 | gpstrspilter |
|---------|-------------|
| 功能描述 | 处理并过滤GP工具输出消息，提取关键信息 |
| 输入参数 | string inputstr：GP工具原始输出文本 |
| 输出参数 | string：过滤后的关键信息 |
| 处理逻辑 | 1. 检查输入是否为空<br>2. 按换行符分割文本<br>3. 提取"正在运行脚本"到"Completed script"之间的内容<br>4. 过滤掉不必要的系统提示<br>5. 组合成新的字符串返回 |
| 适用范围 | GP工具日志处理，地理处理任务信息提取 |

---

#### 2. INI配置文件操作类 (IniFunc)

| 方法名称 | getString |
|---------|----------|
| 功能描述 | 从INI配置文件中读取指定键的值 |
| 输入参数 | string key：配置项的键名 |
| 输出参数 | string：读取到的配置值 |
| 处理逻辑 | 1. 创建StringBuilder缓冲区（大小1024）<br>2. 调用GetPrivateProfileString Windows API<br>3. 从INI文件的"Information"节读取指定键的数据<br>4. 将读取结果转换为字符串返回 |
| 适用范围 | 系统配置读取，参数获取，用户设置读取 |

| 方法名称 | writeString |
|---------|------------|
| 功能描述 | 向INI配置文件写入指定键值对 |
| 输入参数 | string key：配置项的键名<br>string val：要写入的值 |
| 输出参数 | void |
| 处理逻辑 | 1. 调用WritePrivateProfileString Windows API<br>2. 将键值对写入INI文件的"Information"节<br>3. 使用预设的INI文件路径（zjzx_config.ini） |
| 适用范围 | 系统配置保存，参数持久化，用户设置保存 |

---

#### 3. 时间处理类 (GetNowTime)

| 方法名称 | nowTime |
|---------|---------|
| 功能描述 | 获取当前时间并格式化为日志时间戳格式 |
| 输入参数 | 无 |
| 输出参数 | string：格式化后的时间字符串（yyyy-MM-dd HH:mm:ss \| ） |
| 处理逻辑 | 1. 获取当前系统时间<br>2. 使用自定义格式字符串格式化<br>3. 在末尾添加分隔符" \| "<br>4. 返回格式化字符串 |
| 适用范围 | 日志时间戳生成，时间记录 |

| 方法名称 | nowtime2 |
|---------|----------|
| 功能描述 | 获取当前时间的标准格式（不带分隔符） |
| 输入参数 | 无 |
| 输出参数 | string：格式化后的时间字符串（yyyy-MM-dd HH:mm:ss） |
| 处理逻辑 | 1. 获取当前系统时间<br>2. 使用自定义格式字符串格式化<br>3. 直接返回格式化字符串 |
| 适用范围 | 文件命名，数据记录 |

| 方法名称 | runtimestr |
|---------|------------|
| 功能描述 | 格式化运行时间显示，优化时间显示格式 |
| 输入参数 | TimeSpan elapsedTime：时间间隔对象 |
| 输出参数 | string：格式化后的时间字符串 |
| 处理逻辑 | 1. 提取时间字符串（前10位）<br>2. 判断是否小于1分钟<br>3. 如果小于1分钟，提取秒数部分并去除前导0<br>4. 如果大于1分钟，去除毫秒部分<br>5. 返回优化后的显示内容 |
| 适用范围 | 运行时间统计，性能监控，任务执行时长显示 |

---

#### 4. 文件选择类 (SelectFileFunc)

| 方法名称 | sf_folder |
|---------|-----------|
| 功能描述 | 显示文件夹选择对话框 |
| 输入参数 | string lastFolderPath：上次选择的文件夹路径（可选）<br>string notice：对话框提示文字（可选，默认"请选择文件夹"） |
| 输出参数 | string：选择的文件夹路径，取消则返回null |
| 处理逻辑 | 1. 创建CommonOpenFileDialog对话框<br>2. 设置对话框标题和初始目录<br>3. 设置IsFolderPicker为true（选择文件夹模式）<br>4. 显示对话框并获取用户选择结果<br>5. 返回选择的文件夹路径 |
| 适用范围 | 文件夹选择界面，路径选择操作，数据目录设置 |

| 方法名称 | sf_selectfile |
|---------|--------------|
| 功能描述 | 显示文件选择对话框 |
| 输入参数 | string extension：文件扩展名（如"txt"、"xlsx"等，空字符串表示所有文件）<br>string lastFolderPath：上次选择的文件夹路径（可选） |
| 输出参数 | string：选择的文件完整路径，取消则返回空字符串 |
| 处理逻辑 | 1. 创建OpenFileDialog对话框<br>2. 根据扩展名设置文件过滤器<br>3. 特殊处理doc/docx等复合扩展名<br>4. 设置初始目录（如果提供）<br>5. 配置对话框属性（单选、恢复目录等）<br>6. 获取用户选择结果 |
| 适用范围 | 文件选择界面，文档操作，数据导入 |

| 方法名称 | sf_savefile |
|---------|-------------|
| 功能描述 | 显示文件保存对话框 |
| 输入参数 | string extension：文件扩展名 |
| 输出参数 | string：保存文件的完整路径，取消则返回空字符串 |
| 处理逻辑 | 1. 创建SaveFileDialog对话框<br>2. 设置对话框标题为"保存文件"<br>3. 设置默认扩展名和文件过滤器<br>4. 显示对话框并获取用户输入<br>5. 返回保存路径 |
| 适用范围 | 文件保存操作，数据导出，结果输出 |

| 方法名称 | sf_workspace |
|---------|--------------|
| 功能描述 | 显示工作空间选择对话框（支持GDB和MDB） |
| 输入参数 | string notice：对话框提示文字（可选，默认"请选择工作空间"） |
| 输出参数 | string：选择的工作空间完整路径，取消则返回null |
| 处理逻辑 | 1. 创建GxDialog实例<br>2. 设置对话框标题，禁用多选<br>3. 创建对象过滤器集合<br>4. 添加文件地理数据库过滤器（.gdb）<br>5. 添加个人地理数据库过滤器（.mdb）<br>6. 显示对话框并获取选择结果<br>7. 返回工作空间完整路径 |
| 适用范围 | 地理数据库选择，工作空间设置，数据源配置 |

| 方法名称 | OpenGxDialog_FC |
|---------|-----------------|
| 功能描述 | 显示要素类选择对话框，支持多选 |
| 输入参数 | 无 |
| 输出参数 | List<string>：选择的要素类完整路径列表 |
| 处理逻辑 | 1. 创建GxDialog实例<br>2. 设置标题为"请选择一个或多个要素类"<br>3. 允许多选（AllowMultiSelect = true）<br>4. 设置对象过滤器为要素类过滤器<br>5. 显示对话框并遍历选择结果<br>6. 将每个要素类的完整路径添加到列表<br>7. 返回路径列表 |
| 适用范围 | 要素类选择，矢量数据加载，批量数据处理 |

| 方法名称 | sf_selectTableFromMDB |
|---------|---------------------|
| 功能描述 | 从MDB数据库中选择表 |
| 输入参数 | 无 |
| 输出参数 | string：选择的表完整路径（MDB路径\\表名），取消则返回null |
| 处理逻辑 | 1. 显示文件选择对话框选择MDB文件<br>2. 使用AccessWorkspaceFactory打开工作空间<br>3. 枚举工作空间中的所有表<br>4. 在自定义窗体中显示表列表<br>5. 用户选择表后返回完整路径 |
| 适用范围 | MDB表选择，属性数据导入，数据库操作 |

---

#### 5. CSV文件操作类 (csvFunc)

| 方法名称 | LoadToolConfig |
|---------|---------------|
| 功能描述 | 从CSV配置文件加载指定工具的配置信息 |
| 输入参数 | string toolname：工具名称 或<br>MenuBean menubean：菜单对象<br>string csvpath：CSV文件路径 |
| 输出参数 | List<string>：匹配的配置行列表 |
| 处理逻辑 | 1. 使用GB2312编码打开CSV文件<br>2. 逐行读取并按逗号分割<br>3. 检查第6列（索引5）是否匹配工具名称<br>4. 如果使用MenuBean，还需匹配文件夹名、工具箱名、工具集名<br>5. 将匹配的行添加到列表<br>6. 处理可能的异常并记录错误日志 |
| 适用范围 | 工具配置加载，参数读取，工具初始化 |

| 方法名称 | LoadTaskCache |
|---------|---------------|
| 功能描述 | 从CSV文件加载任务缓存数据 |
| 输入参数 | string csvpath：CSV文件路径 |
| 输出参数 | List<ToolArgs>：工具参数对象列表 |
| 处理逻辑 | 1. 使用GB2312编码打开CSV文件<br>2. 跳过表头行（第一行）<br>3. 逐行解析，确保列数至少为12<br>4. 调用CreatArgBean方法创建ToolArgs对象<br>5. 设置nowValue属性（第12列，索引11）<br>6. 将有效对象添加到列表<br>7. 记录解析失败的行和列数不足的行 |
| 适用范围 | 任务缓存恢复，历史任务加载，参数重用 |

| 方法名称 | PreprocessCsv |
|---------|---------------|
| 功能描述 | 预处理CSV文件，确保每行都有足够的列 |
| 输入参数 | string csvPath：CSV文件路径 |
| 输出参数 | void |
| 处理逻辑 | 1. 使用GB2312编码读取所有行<br>2. 遍历每一行，按逗号分割<br>3. 检查列数是否少于12列<br>4. 如果不足，在行末添加逗号补齐<br>5. 将预处理后的内容写回文件<br>6. 处理异常并记录错误日志 |
| 适用范围 | CSV文件格式修复，数据预处理，文件规范化 |

---

#### 6. 文件复制类 (myCopyFunc)

| 方法名称 | CopyDirectory |
|---------|---------------|
| 功能描述 | 递归复制整个目录及其内容 |
| 输入参数 | string sourceDir：源目录路径<br>string destDir：目标目录路径 |
| 输出参数 | void |
| 处理逻辑 | 1. 检查源目录是否存在<br>2. 创建目标目录（如果不存在）<br>3. 复制源目录中的所有文件<br>4. 递归复制所有子目录<br>5. 处理异常并记录错误日志 |
| 适用范围 | 目录备份，模板复制，数据迁移 |

---

## 1.4 公用数据结构

### GpBean
GP任务对象，用于封装地理处理任务的相关信息

| 属性名 | 类型 | 说明 |
|--------|------|------|
| TaskName | string | 任务名称 |
| ToolPath | string | 工具路径 |
| Parameters | Dictionary | 参数字典 |
| Status | int | 任务状态 |

### ToolArgs
工具参数对象，用于封装工具的输入输出参数

| 属性名 | 类型 | 说明 |
|--------|------|------|
| folderName | string | 文件夹名称 |
| toolboxName | string | 工具箱名称 |
| toolsetName | string | 工具集名称 |
| toolName | string | 工具名称 |
| argName | string | 参数名称 |
| argType | string | 参数类型 |
| defaultValue | string | 默认值 |
| nowValue | string | 当前值 |
| isRequired | bool | 是否必需 |

### MenuBean
菜单对象，用于封装菜单项信息

| 属性名 | 类型 | 说明 |
|--------|------|------|
| folderName | string | 文件夹名称 |
| toolboxName | string | 工具箱名称 |
| toolsetName | string | 工具集名称 |
| toolName | string | 工具名称 |
| displayName | string | 显示名称 |
| description | string | 工具描述 |

---

## 1.5 错误处理机制

所有公用方法均采用统一的错误处理机制：

1. **异常捕获**：使用try-catch块捕获所有可能的异常
2. **日志记录**：通过LogHelper.ErrorLog方法记录错误信息
3. **用户通知**：关键错误通过Notification组件弹窗提示用户
4. **线程安全**：日志写入操作使用lock机制保证线程安全
5. **资源释放**：使用using语句确保文件流等资源正确释放

---

## 1.6 线程安全说明

### 需要注意线程安全的场景：

1. **日志写入**：使用fileLock对象确保同一时间只有一个线程写入日志文件
2. **UI更新**：使用BeginInvoke或Invoke确保UI操作在主线程执行
3. **全局变量访问**：访问globalpara中的静态变量时注意并发控制

### 推荐做法：

- 对共享资源使用lock关键字进行同步
- UI相关操作通过Invoke/BeginInvoke回到主线程
- 使用线程安全的集合类型（如ConcurrentDictionary）

---

## 1.7 调用示例

### 示例1：记录日志
```csharp
// 记录普通日志
LogHelper.add2mainlog("数据处理完成");

// 记录错误日志
try 
{
    // 业务代码
}
catch (Exception ex)
{
    LogHelper.ErrorLog("数据处理失败", ex);
}

// 显示成功通知
LogHelper.Successnotice("任务执行成功");
```

### 示例2：读写配置
```csharp
// 读取配置
string resultdb = IniFunc.getString("resultdb");

// 写入配置
IniFunc.writeString("resultdb", @"C:\Data\result.gdb");
```

### 示例3：文件选择
```csharp
SelectFileFunc sf = new SelectFileFunc();

// 选择文件夹
string folder = sf.sf_folder("", "请选择数据目录");

// 选择文件
string file = sf.sf_selectfile("shp", "");

// 选择工作空间
string workspace = sf.sf_workspace("请选择输出工作空间");

// 选择要素类
List<string> fcList = sf.OpenGxDialog_FC();
```

### 示例4：加载工具配置
```csharp
csvFunc csv = new csvFunc();

// 加载指定工具的配置
List<string> config = csv.LoadToolConfig("缓冲区分析");

// 加载任务缓存
List<ToolArgs> taskArgs = csv.LoadTaskCache(globalpara.taskcachepath);
```

### 示例5：获取时间
```csharp
// 获取当前时间戳
string timestamp = GetNowTime.nowTime();
// 结果：2024-01-15 14:30:25 | 

// 格式化运行时间
TimeSpan elapsed = stopwatch.Elapsed;
string runtime = GetNowTime.runtimestr(elapsed);
// 结果：3.25秒 或 00:05:30
```
